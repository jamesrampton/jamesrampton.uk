{{ define "main" }}
<h2 class="post-title">{{ .Title }}</h2>

<div class="post-content">
    {{ if isset .Params "images" }}
        {{ $featured_image := index (.Params.Images) 0 }}
        <img src="{{ $featured_image }}" alt="{{ .Params.featured_image_alt_text }}">
    {{ end }}
    {{ if isset .Params "featured_image_credit" }}<p class="right image-credit">Image credit: {{ .Params.featured_image_credit }}{{ end }}</p>
    <div class="center">
        {{ .Content }}
        <section class="gallery">
            {{ $images := sort (.Page.Resources.Match "img/*.jpg") "Exif.Date" "desc" }}
            {{ range $images }}
            {{ $prethumbnail := .Fill "2x2 q80" }}
            {{ $thumbnail := .Fill "250x250 q100" }}
            <a class="gallery-thumb" href="{{ .RelPermalink }}">
                <img class="lazy-image" src="{{ $prethumbnail.RelPermalink }}" data-src="{{ $thumbnail.RelPermalink }}" width="300" height="300">
            </a>
            {{ end }}
        </section>
    </div>
</div>
<script>
    document.body.innerHTML += '<div id="gallery-container"><div id="image-loader">{{- partial "logo.html" }}</div><div id="image-wrapper"></div><div class="gallery-close">&times;</div></div>';
    var container = document.getElementById('gallery-container');
    var imageWrapper = document.getElementById('image-wrapper');
    container.addEventListener('click', function(){
        this.classList.remove("active");
        document.body.classList.remove('no-overflow');
    });

    document.addEventListener("DOMContentLoaded", function() {
        var lazyloadImages = document.querySelectorAll("img.lazy-image");
        var lazyloadThrottleTimeout;

        function lazyload () {
            if(lazyloadThrottleTimeout) {
                clearTimeout(lazyloadThrottleTimeout);
            }

            lazyloadThrottleTimeout = setTimeout(function() {
                var scrollTop = window.pageYOffset;
                lazyloadImages.forEach(function(img) {
                    if(img.offsetTop < (window.innerHeight + scrollTop)) {
                        img.src = img.dataset.src;
                        img.classList.remove('lazy-image');
                    }
                });
                if(lazyloadImages.length == 0) {
                    document.removeEventListener("scroll", lazyload);
                    window.removeEventListener("resize", lazyload);
                    window.removeEventListener("orientationChange", lazyload);
                }
            }, 20);
        }
        lazyload();

        document.addEventListener("scroll", lazyload);
        window.addEventListener("resize", lazyload);
        window.addEventListener("orientationChange", lazyload);
    });

    var thumbs = document.getElementsByClassName('gallery-thumb');
    for (var i = 0; i < thumbs.length; i++) {
        thumbs[i].addEventListener('click', function(event){
            event.preventDefault();
            container.classList.add("active");
            document.body.classList.add('no-overflow');
            imageWrapper.style.backgroundImage = "url("+ this.getAttribute('href') + ")";
        });
    }
</script>
{{ end }}
